<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€è®¡æ—¶å™¨ Pro Max (å«JSONå¤‡ä»½)</title>
    <style>
        :root {
            --bg: #f2f2f7; --card: #ffffff; --primary: #007AFF; --accent: #34C759;
            --danger: #FF3B30; --text: #1c1c1e; --secondary-text: #8e8e93;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* å¯¼èˆªä¸åŸºç¡€ */
        .top-nav { background: var(--card); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e5ea; z-index: 100; }
        .nav-logo { font-weight: 800; color: var(--primary); font-size: 1.1rem; letter-spacing: -1px; }
        .nav-buttons { display: flex; gap: 6px; }
        .nav-btn { background: #f2f2f7; border: none; padding: 8px 12px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.85rem; }

        .modal { position: fixed; inset: 0; background: var(--bg); z-index: 1000; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .modal.open { transform: translateY(0); }
        .modal-header { padding: 15px 20px; background: var(--card); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e5ea; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* ç»Ÿè®¡å›¾è¡¨ */
        .stats-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .summary-card { background: var(--card); padding: 15px; border-radius: 16px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .summary-value { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
        
        .chart-container { background: var(--card); border-radius: 20px; padding: 20px; }
        .chart-row { margin-bottom: 15px; }
        .chart-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; }
        .chart-bar-bg { background: #f2f2f7; height: 14px; border-radius: 7px; overflow: hidden; }
        .chart-bar-fill { height: 100%; border-radius: 7px; transition: width 0.8s ease; background: var(--primary); }

        /* è®¡æ—¶å™¨æ ¸å¿ƒ */
        .main-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; }
        .timer-wrap { position: relative; width: 280px; height: 280px; }
        .progress-ring__circle { transition: stroke-dashoffset 0.3s linear, stroke 0.3s; stroke-linecap: round; }
        .timer-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .time-text { font-size: 4.8rem; font-weight: 800; letter-spacing: -3px; }

        /* é€šç”¨ç»„ä»¶ */
        .section-title { font-size: 0.75rem; color: var(--secondary-text); text-transform: uppercase; margin: 20px 0 10px; font-weight: 700; }
        .task-card { background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .btn-full { width: 100%; padding: 15px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .tag-badge { background: #E1EFFF; color: var(--primary); padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="nav-logo">FOCUS PRO</div>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="openModal('statsModal')">ğŸ“Š ç»Ÿè®¡</button>
            <button class="nav-btn" onclick="openModal('taskModal')">âš™ï¸ é…ç½®</button>
            <button class="nav-btn" onclick="openModal('logModal')">ğŸ“œ å†å²</button>
        </div>
    </nav>

    <div id="statsModal" class="modal">
        <div class="modal-header">
            <h2>æ•°æ®æ´å¯Ÿ</h2>
            <button class="nav-btn" onclick="closeModal('statsModal')">å…³é—­</button>
        </div>
        <div class="modal-body">
            <div class="stats-summary">
                <div class="summary-card"><div class="summary-value" id="totalCount">0æ¬¡</div><small>æ€»æ¬¡æ•°</small></div>
                <div class="summary-card"><div class="summary-value" id="totalTime">00:00</div><small>ä¸“æ³¨æ—¶é•¿</small></div>
            </div>
            
            <div class="section-title">æ—¶é•¿åˆ†å¸ƒæ¯”è¾ƒ</div>
            <div id="chartBox" class="chart-container"></div>

            <div class="section-title">æ•°æ®ç®¡ç† (JSON)</div>
            <div class="action-grid">
                <button class="nav-btn" style="background:#34C759; color:white" onclick="exportFullData()">ğŸ’¾ å¯¼å‡ºJSON</button>
                <button class="nav-btn" style="background:#5856D6; color:white" onclick="document.getElementById('importInput').click()">ğŸ“‚ å¯¼å…¥JSON</button>
            </div>
            <input type="file" id="importInput" style="display:none" accept=".json" onchange="importFullData(event)">
            <p style="font-size:0.7rem; color:var(--secondary-text); text-align:center; margin-top:10px">
                å¯¼å‡ºçš„æ–‡ä»¶åŒ…å«æ‰€æœ‰ä»»åŠ¡é…ç½®å’Œå†å²è®°å½•
            </p>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-header">
            <h2>ä»»åŠ¡ç®¡ç†</h2>
            <button class="nav-btn" onclick="closeModal('taskModal')">å…³é—­</button>
        </div>
        <div class="modal-body">
            <div class="section-title">æ·»åŠ /ç¼–è¾‘ä»»åŠ¡</div>
            <div style="background:white; padding:15px; border-radius:16px">
                <input type="text" id="taskName" class="nav-btn" style="width:100%; text-align:left; margin-bottom:8px; background:#f9f9f9" placeholder="ä»»åŠ¡åç§°">
                <div style="display:flex; gap:8px">
                    <input type="number" id="waitS" class="nav-btn" style="flex:1; background:#f9f9f9" placeholder="å‡†å¤‡(ç§’)">
                    <input type="number" id="workS" class="nav-btn" style="flex:1; background:#f9f9f9" placeholder="æ‰§è¡Œ(ç§’)">
                </div>
                <button id="saveBtn" class="btn-full" style="background:var(--primary); color:white" onclick="handleSave()">ä¿å­˜ä»»åŠ¡</button>
            </div>
            <div class="section-title">ä»»åŠ¡åˆ—è¡¨</div>
            <div id="taskList"></div>
        </div>
    </div>

    <div id="logModal" class="modal">
        <div class="modal-header">
            <h2>æœ€è¿‘è®°å½•</h2>
            <button class="nav-btn" onclick="closeModal('logModal')">å…³é—­</button>
        </div>
        <div class="modal-body">
            <div id="logList"></div>
            <button class="btn-full" style="color:var(--danger); background:none; border:1px solid var(--danger)" onclick="clearLogs()">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
        </div>
    </div>

    <main class="main-content">
        <div class="timer-wrap">
            <svg width="280" height="280" style="transform: rotate(-90deg)">
                <circle cx="140" cy="140" r="130" stroke="#e5e5ea" stroke-width="8" fill="none"/>
                <circle id="progress" cx="140" cy="140" r="130" stroke="var(--primary)" stroke-width="8" fill="none"
                        stroke-dasharray="816.8" stroke-dashoffset="0" class="progress-ring__circle"/>
            </svg>
            <div class="timer-display">
                <span id="time" class="time-text">00:00</span>
                <span id="status" style="color:var(--secondary-text); font-weight:700">READY</span>
            </div>
        </div>
        <div id="currentInfo" style="margin-top:40px; text-align:center">
            <h2 id="currentName" style="margin:0; color:var(--text)">é€‰æ‹©ä¸€ä¸ªä»»åŠ¡</h2>
        </div>
    </main>

<script>
    // --- éŸ³æ•ˆæ¨¡å— ---
    let audioCtx = null;
    function playSound(type) {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.value = type === 'end' ? 880 : 440;
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.5);
    }

    // --- æ•°æ®ä¸­å¿ƒ ---
    let tasks = JSON.parse(localStorage.getItem('focus_tasks')) || [];
    let logs = JSON.parse(localStorage.getItem('focus_logs')) || [];
    const perimeter = 816.8;

    function save() {
        localStorage.setItem('focus_tasks', JSON.stringify(tasks));
        localStorage.setItem('focus_logs', JSON.stringify(logs));
    }

    // --- JSON å¯¼å…¥å¯¼å‡º ---
    function exportFullData() {
        const data = { tasks, logs, exportAt: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `timer_backup_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importFullData(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = JSON.parse(event.target.result);
                if(data.tasks && data.logs) {
                    if(confirm("å¯¼å…¥å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ")) {
                        tasks = data.tasks;
                        logs = data.logs;
                        save();
                        location.reload();
                    }
                }
            } catch(err) { alert("æ–‡ä»¶æ ¼å¼é”™è¯¯"); }
        };
        reader.readAsText(file);
    }

    // --- é¡µé¢é€»è¾‘ ---
    function openModal(id) { 
        document.getElementById(id).classList.add('open'); 
        if(id === 'statsModal') renderStats();
        if(id === 'taskModal') renderTasks();
        if(id === 'logModal') renderLogs();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }

    function renderStats() {
        const totalSec = logs.reduce((s, l) => s + l.duration, 0);
        document.getElementById('totalCount').innerText = logs.length + 'æ¬¡';
        document.getElementById('totalTime').innerText = format(totalSec);

        const stats = {};
        logs.forEach(l => stats[l.task] = (stats[l.task] || 0) + l.duration);
        const sorted = Object.entries(stats).sort((a,b) => b[1] - a[1]);
        const max = sorted[0]?.[1] || 1;

        document.getElementById('chartBox').innerHTML = sorted.map(([name, val], i) => `
            <div class="chart-row">
                <div class="chart-label"><span>${name}</span><strong>${val}s</strong></div>
                <div class="chart-bar-bg">
                    <div class="chart-bar-fill" style="width:${(val/max*100)}%; background:hsl(${i*40}, 70%, 50%)"></div>
                </div>
            </div>
        `).join('') || '<p style="text-align:center;color:#999">æš‚æ— ç»Ÿè®¡æ•°æ®</p>';
    }

    function renderTasks() {
        document.getElementById('taskList').innerHTML = tasks.map(t => `
            <div class="task-card">
                <div><strong>${t.name}</strong><br><small>${t.waitS}s + ${t.workS}s</small></div>
                <div style="display:flex; gap:5px">
                    <button class="nav-btn" style="background:var(--accent); color:white" onclick="runTask('${t.name}')">â–¶</button>
                    <button class="nav-btn" onclick="deleteTask('${t.name}')">âœ•</button>
                </div>
            </div>
        `).join('');
    }

    function renderLogs() {
        document.getElementById('logList').innerHTML = logs.slice().reverse().slice(0,20).map(l => `
            <div class="task-card" style="font-size:0.8rem">
                <div><strong>${l.task}</strong></div>
                <div style="color:var(--secondary-text)">${l.at.split(' ')[1]} | ${l.duration}s</div>
            </div>
        `).join('');
    }

    function handleSave() {
        const n = document.getElementById('taskName').value;
        const wa = parseInt(document.getElementById('waitS').value) || 0;
        const wo = parseInt(document.getElementById('workS').value) || 1;
        if(!n) return;
        tasks.push({name:n, waitS:wa, workS:wo});
        save(); renderTasks();
    }

    async function runTask(name) {
        const t = tasks.find(x => x.name === name);
        closeModal('taskModal');
        document.getElementById('currentName').innerText = t.name;
        
        if(t.waitS > 0) {
            await startClock(t.waitS, "å‡†å¤‡", "var(--primary)", true);
            playSound('wait');
        }
        await startClock(t.workS, "ä¸“æ³¨ä¸­", "var(--accent)", false);
        playSound('end');
        
        logs.push({ task: t.name, duration: t.workS, at: new Date().toLocaleString() });
        save();
        document.getElementById('status').innerText = "å®Œæˆ";
    }

    function startClock(dur, label, color, isCD) {
        return new Promise(res => {
            let s = isCD ? dur : 0;
            document.getElementById('status').innerText = label;
            document.getElementById('progress').style.stroke = color;
            const itv = setInterval(() => {
                isCD ? s-- : s++;
                document.getElementById('time').innerText = format(s);
                document.getElementById('progress').style.strokeDashoffset = perimeter - (s/dur * perimeter);
                if((isCD && s<=0) || (!isCD && s>=dur)) { clearInterval(itv); res(); }
            }, 1000);
        });
    }

    function format(s) {
        return Math.floor(s/60).toString().padStart(2,'0') + ':' + (s%60).toString().padStart(2,'0');
    }
    
    function deleteTask(name) { tasks = tasks.filter(t => t.name !== name); save(); renderTasks(); }
    function clearLogs() { if(confirm("æ¸…ç©ºå†å²æ•°æ®ï¼Ÿ")) { logs = []; save(); renderLogs(); } }
</script>
</body>
</html>