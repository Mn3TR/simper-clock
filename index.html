<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <title>极简计时</title>
    <style>
        :root {
            --bg: #f2f2f7;
            --card: #ffffff;
            --primary: #007AFF;
            --accent: #34C759;
            --danger: #FF3B30;
            --text: #1c1c1e;
            --secondary-text: #8e8e93;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .app-card {
            background: var(--card);
            width: 100%;
            max-width: 500px;
            padding: 2rem;
            border-radius: 28px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center; /* 元素居中 */
            text-align: center;
        }

        /* 环形进度条居中 */
        .timer-section {
            position: relative;
            width: 220px;
            height: 220px;
            margin-bottom: 1.5rem;
        }

        .progress-ring { transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 0.3s linear, stroke 0.3s; }

        .timer-display {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        .time-num { font-size: 3rem; font-weight: 700; display: block; }
        .status-text { font-size: 0.9rem; color: var(--secondary-text); }

        /* 输入与控制区 */
        .controls, .task-manager { width: 100%; margin-top: 1rem; }

        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 1.5rem;
            justify-content: center;
        }

        input {
            padding: 10px;
            border: 1px solid #d1d1d6;
            border-radius: 10px;
            outline: none;
            width: 80px;
        }
        input#nameInp { width: 140px; }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: #e5e5ea; color: var(--text); }
        .btn-history { background: #f2f2f7; color: var(--primary); margin-top: 10px; width: 100%; }

        button:hover { opacity: 0.8; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        /* 任务列表 */
        .task-list {
            width: 100%;
            margin-top: 2rem;
            max-height: 250px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f8fa;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 2px solid transparent;
        }

        .task-item.running { border-color: var(--primary); background: #f0f7ff; }

        .task-info { text-align: left; }
        .task-actions { display: flex; gap: 5px; }
        
        .btn-small { padding: 6px 10px; font-size: 0.8rem; }
        .btn-run { background: var(--accent); color: white; }
        .btn-del { background: #ffebeb; color: var(--danger); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d1d1d6; border-radius: 10px; }
    </style>
</head>
<body>

<div class="app-card">
    <div class="timer-section">
        <svg class="progress-ring" width="220" height="220">
            <circle stroke="#eee" stroke-width="10" fill="transparent" r="100" cx="110" cy="110"/>
            <circle id="progressCircle" stroke="var(--primary)" stroke-width="10" 
                    stroke-dasharray="628.3" stroke-dashoffset="0" 
                    fill="transparent" r="100" cx="110" cy="110" class="progress-ring__circle"/>
        </svg>
        <div class="timer-display">
            <span id="display" class="time-num">00:00</span>
            <span id="statusLabel" class="status-text">就绪</span>
        </div>
    </div>

    <div class="task-manager">
        <div class="input-group">
            <input type="text" id="nameInp" placeholder="任务名">
            <input type="number" id="cdInp" placeholder="等待">
            <input type="number" id="swInp" placeholder="计时">
            <button class="btn-primary" onclick="addTask()">添加</button>
        </div>

        <div class="button-grid">
            <button id="exportTasks" class="btn-outline" onclick="exportJSON('tasks')">导出配置</button>
            <button id="exportLogs" class="btn-outline" onclick="exportJSON('logs')">导出记录</button>
        </div>
    </div>

    <div id="taskList" class="task-list">
        </div>
</div>

<script>
    let tasks = JSON.parse(localStorage.getItem('spa_tasks')) || [];
    let logs = JSON.parse(localStorage.getItem('spa_logs')) || [];
    let timer = null;
    const circle = document.getElementById('progressCircle');
    const circumference = 2 * Math.PI * 100;

    function init() {
        renderTasks();
        setProgress(0, 'var(--primary)');
    }

    function renderTasks() {
        const listEl = document.getElementById('taskList');
        listEl.innerHTML = tasks.length === 0 ? '<p style="color:#8e8e93">暂无任务</p>' : '';
        tasks.forEach((task, index) => {
            const div = document.createElement('div');
            div.className = 'task-item';
            div.id = `task-${index}`;
            div.innerHTML = `
                <div class="task-info">
                    <strong>${task.name}</strong><br>
                    <small>${task.cd}s / ${task.sw}s</small>
                </div>
                <div class="task-actions">
                    <button class="btn-small btn-run" onclick="runSingleTask(${index})">运行</button>
                    <button class="btn-small btn-del" onclick="removeTask(${index})">删除</button>
                </div>
            `;
            listEl.appendChild(div);
        });
        localStorage.setItem('spa_tasks', JSON.stringify(tasks));
        localStorage.setItem('spa_logs', JSON.stringify(logs));
    }

    function addTask() {
        const name = document.getElementById('nameInp').value || "任务";
        const cd = parseInt(document.getElementById('cdInp').value) || 5;
        const sw = parseInt(document.getElementById('swInp').value) || 10;
        tasks.push({ name, cd, sw });
        renderTasks();
    }

    function removeTask(i) {
        tasks.splice(i, 1);
        renderTasks();
    }

    function setProgress(percent, color) {
        const offset = circumference - (percent / 100) * circumference;
        circle.style.strokeDashoffset = offset;
        circle.style.stroke = color;
    }

    function formatTime(s) {
        return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
    }

    async function runSingleTask(index) {
        if (timer) clearInterval(timer);
        const task = tasks[index];
        const taskEl = document.getElementById(`task-${index}`);
        
        // UI 状态
        document.querySelectorAll('.task-item').forEach(el => el.classList.remove('running'));
        taskEl.classList.add('running');
        disableAllButtons(true);

        // 执行逻辑
        await startTimer(task.cd, "等待中...", "var(--primary)", true);
        await startTimer(task.sw, "进行中...", "var(--accent)", false);

        // 记录历史
        logs.push({
            taskName: task.name,
            timestamp: new Date().toLocaleString(),
            duration: task.sw
        });
        
        document.getElementById('statusLabel').innerText = "已完成";
        taskEl.classList.remove('running');
        disableAllButtons(false);
        renderTasks(); // 更新本地存储
    }

    function startTimer(duration, label, color, isCountdown) {
        return new Promise(resolve => {
            let count = isCountdown ? duration : 0;
            document.getElementById('statusLabel').innerText = label;
            document.getElementById('display').innerText = formatTime(count);
            
            timer = setInterval(() => {
                isCountdown ? count-- : count++;
                document.getElementById('display').innerText = formatTime(count);
                
                let percent = isCountdown ? (count / duration) * 100 : (count / duration) * 100;
                setProgress(percent, color);

                if ((isCountdown && count <= 0) || (!isCountdown && count >= duration)) {
                    clearInterval(timer);
                    resolve();
                }
            }, 1000);
        });
    }

    function disableAllButtons(disabled) {
        document.querySelectorAll('button').forEach(btn => btn.disabled = disabled);
    }

    function exportJSON(type) {
        const data = type === 'tasks' ? tasks : logs;
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${type}_${new Date().getTime()}.json`;
        a.click();
    }

    init();
</script>

</body>
</html>